# 把“垃圾式”遗留代码清运成可读文档

每个团队都有一段“不敢动的代码”。接口在哪里？入参出参怎么传？谁负责？没人能一口气说清。

GJavaDoc 做一件简单但有用的事：在 IntelliJ 里，一键把基于注解暴露的接口，整理成结构化的 Markdown 文档；必要时再补一点语义推断，交付“能看、能审、能对接”的结果。

---

## 1. 它的思路

- 注解定位：按配置的注解（默认 `@RpcService`）找到“入口方法”。
- 上下文打包：把入口源码、调用摘要、片段与关联类型拼成可读上下文。
- 生成文档：调用本地/内网 LLM，输出固定格式的 Markdown（可选 JSON）。
- 增量与并发：只为缺失条目入队；支持并发、RPS 限速、失败重试与退避。

一句话：先把信息找齐，再把文字写好。

---

## 2. 十分钟上手

1) 运行：在项目根目录执行 `./gradlew runIde`，打开 IDEA 的 “GJavaDoc” 工具窗。

2) 配置：Settings 里填注解（支持多个，逗号分隔），可选配置 LLM Endpoint/Model（或先用 Stub 占位）。

3) 扫描：选择 Module 或 ALL，点击 Run Scan。

4) 产出：
- `docs/`：接口文档（最终产物）
- `context-bundles/`：上下文（提示输入）
- `method-docs/`：可选 JSON

5) 再次扫描：内置增量策略，已存在的“同类+同签名”会跳过。

---

## 3. 三个典型场景

- 新人接手老项目（摸清接口面）
  - 做法：勾选 READ/OTHER，按模块分目录输出，先拿到 80% 可用文档。
  - 收益：第一天就能“讲清楚”，不是“到处问”。

- 外部团队火速对接（48 小时出册）
  - 做法：只扫对接模块；自定义 Prompt 强化“输入/输出表格必须齐全”；固定 temperature/top_p 保稳定。
  - 收益：往返次数下降，字段缺漏减少。

- 重构/迁移前做基线（可比对的凭据）
  - 做法：全量扫一版入库；重构后再扫做 diff；失败任务集中重试。
  - 收益：从“敢不敢动”到“动完不漏”的确定性。

---

## 4. 文档长什么样（文字示意）

- 基础信息：接口名称（类.方法）、一句话说明（必要时标“推断”）、请求方式（按方法名前缀推断 GET/POST/PUT/DELETE）。
- 输入参数：形参直列；DTO/VO 展开一层；Map/JSON 尝试展开；常见 `qc.*` 条件标默认值与是否必须。
- 输出参数：包装类通用字段（`code/message/success`）+ 主要结果字段；分页结构列 `total/pageNo/pageSize/records[]`。
- 组织方式：默认平铺 `docs/`；勾“Group docs by module”后输出到 `docs/<module>/...`。

这不是替代注释，而是把“接口视角”的关键信息拎到一页。

---

## 5. 团队落地建议

- 从小处开始：挑一个业务模块，生成文档给前端/QA，收集“缺少解释”的反馈。
- 建立节奏：每周例会前跑一次增量；大版本前跑一次全量，文档进仓库。
- 分工协作：
  - 后端：维护入口注解与 CRUD 前缀；关键方法补一两句注释。
  - 测试/产品：基于文档补“业务语言”，推动描述一致。
  - 平台/架构：沉淀自定义 Prompt 与领域词典，跨项目复用。
- 回写到代码：把补充的解释回写注释，下次生成更准。

---

## 6. 提升质量的四个小技巧

- 方法命名：动词+领域词（如 `queryUserDetail`），HTTP 推断更稳。
- CRUD 前缀：按团队习惯配置 create/read/update/delete 列表，减少误判。
- Prompt 收紧：明确“表格必须完整，不要省略”，降低格式漂移。
- 粒度选择：方法级更细更准；类内语义统一时再启用“类级文档”。

---

## 7. 常见问题与规避

- 索引未就绪：IDE 处于 Dumb Mode 会报错，等索引完成再跑。
- 代码花式写法：库/合成方法可能取不到完整文本，降低“上下文深度”或关闭“收集被调方法”后重试。
- 幻觉与稳定性：关键字段务必人工复核；调低 temperature/top_p，输出更稳。
- 判重策略：仅以 `docs/` 判重；清空或改名会触发重新入队（特性）。

---

## 8. 为什么是 IDE 插件

- 离代码最近：即点即用；模块选择、增量跳过、失败重试在一个工具窗完成。
- 产物易协作：Markdown 天然适合进仓库、评审、对接与长久维护。

---

## 9. 一句话总结

GJavaDoc 不是“自动写注释”，而是“把分散线索收拢成一页”。把难啃的“垃圾式”遗留代码，清运成能用、能维护的接口文档。

---

## 对外精简版

GJavaDoc：把遗留系统的“口口相传”变成一份可读的接口册。

- 一键生成：按注解发现入口方法，输出结构化 Markdown（可选 JSON）。
- 上下文友好：自动打包源码片段与调用摘要，减少理解成本。
- 稳定可复用：增量扫描、并发与限速、失败重试，文档进仓库即可协作。
- 十分钟上手：`./gradlew runIde` → 选择模块 → Run Scan → 产物在 `docs/`。
- 更贴合团队：CRUD 前缀可自定义，支持按模块分目录、Prompt 模板自定义。

适用：新人接手、外部对接、重构/迁移前基线梳理。

一句话：先把信息找齐，再把文字写好。
